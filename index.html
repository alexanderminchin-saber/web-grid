<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridBoard</title>
    
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (To compile JSX in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .fade-enter { opacity: 0; transform: translateY(-10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: all 300ms; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Icon Components ---
        const Icon = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Plus = (props) => <Icon {...props}><path d="M5 12h14" /><path d="M12 5v14" /></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></Icon>;
        const Move = (props) => <Icon {...props}><polyline points="5 9 2 12 5 15" /><polyline points="9 5 12 2 15 5" /><polyline points="15 19 12 22 9 19" /><polyline points="19 15 22 12 19 9" /><line x1="2" x2="22" y1="12" y2="12" /><line x1="12" x2="12" y1="2" y2="22" /></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></Icon>;
        const Globe = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /><path d="M2 12h20" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></Icon>;
        const Maximize2 = (props) => <Icon {...props}><polyline points="15 3 21 3 21 9" /><polyline points="9 21 3 21 3 15" /><line x1="21" x2="14" y1="3" y2="10" /><line x1="3" x2="10" y1="21" y2="14" /></Icon>;
        const GridIcon = (props) => <Icon {...props}><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></Icon>;
        const ChevronUp = (props) => <Icon {...props}><path d="m18 15-6-6-6 6" /></Icon>;
        const Monitor = (props) => <Icon {...props}><rect width="20" height="14" x="2" y="3" rx="2" /><line x1="8" x2="16" y1="21" y2="21" /><line x1="12" x2="12" y1="17" y2="21" /></Icon>;
        const LayoutIcon = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M3 9h18" /><path d="M9 21V9" /></Icon>;
        const MenuIcon = (props) => <Icon {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></Icon>;
        const SaveIcon = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>;

        // --- Constants ---
        const GRID_SIZE = 20;
        const SESSION_KEY = 'dashboard_last_session';
        const COLLECTIONS_KEY = 'dashboard_saved_collections';
        const DEFAULT_W = 400;
        const DEFAULT_H = 300;

        const snap = (v) => Math.round(v / GRID_SIZE) * GRID_SIZE;
        const generateId = () => Math.random().toString(36).substr(2, 9);

        function App() {
            const [panes, setPanes] = useState([]);
            const [urlInput, setUrlInput] = useState('');
            const [isHeaderVisible, setIsHeaderVisible] = useState(true);
            const [compactMode, setCompactMode] = useState(false);
            const [dragState, setDragState] = useState(null); 
            
            // Stored Layouts State
            const [savedCollections, setSavedCollections] = useState({});
            const [activeCollectionName, setActiveCollectionName] = useState('');
            
            const isInteracting = !!dragState;
            const mainRef = useRef(null);

            // 1. Initial Load
            useEffect(() => {
                // Load last session
                const lastSession = localStorage.getItem(SESSION_KEY);
                if (lastSession) {
                    try {
                        const parsed = JSON.parse(lastSession);
                        if (Array.isArray(parsed)) setPanes(parsed);
                    } catch (e) {}
                }

                // Load named collections
                const collections = localStorage.getItem(COLLECTIONS_KEY);
                if (collections) {
                    try {
                        setSavedCollections(JSON.parse(collections));
                    } catch (e) {}
                }
            }, []);

            // 2. Auto-save session
            useEffect(() => {
                localStorage.setItem(SESSION_KEY, JSON.stringify(panes));
            }, [panes]);

            // --- Storage Actions ---

            const saveCurrentLayout = () => {
                const name = prompt("Enter a name for this dashboard layout:", activeCollectionName || "My Dashboard");
                if (!name || name.trim() === "") return;
                
                const updated = { ...savedCollections, [name]: panes };
                setSavedCollections(updated);
                localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(updated));
                setActiveCollectionName(name);
            };

            const loadCollection = (name) => {
                if (!name) return;
                if (savedCollections[name]) {
                    setPanes(savedCollections[name]);
                    setActiveCollectionName(name);
                }
            };

            const deleteCollection = () => {
                if (!activeCollectionName) return;
                if (confirm(`Delete the saved layout "${activeCollectionName}"?`)) {
                    const updated = { ...savedCollections };
                    delete updated[activeCollectionName];
                    setSavedCollections(updated);
                    localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(updated));
                    setActiveCollectionName('');
                }
            };

            // --- JSON Import/Export ---

            const exportToJson = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(panes));
                const link = document.createElement('a');
                link.setAttribute("href", dataStr);
                link.setAttribute("download", `${activeCollectionName || 'dashboard'}_layout.json`);
                link.click();
            };

            const importFromJson = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            setPanes(imported);
                            setActiveCollectionName(''); // Clear active name as it's a new import
                        } else {
                            alert('Invalid layout file format.');
                        }
                    } catch (err) {
                        alert('Error parsing JSON file.');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            };

            // --- Pane Management ---

            const findOpenSpot = (width, height) => {
                if (panes.length === 0) return { x: 20, y: 20 };
                const canvasWidth = mainRef.current ? mainRef.current.clientWidth : window.innerWidth;
                let cx = 20, cy = 20, attempts = 0;
                while (attempts < 1000) {
                    const hit = panes.some(p => cx < p.x + p.w && cx + width > p.x && cy < p.y + p.h && cy + height > p.y);
                    if (!hit) return { x: cx, y: cy };
                    cx += GRID_SIZE;
                    if (cx + width > canvasWidth) { cx = 20; cy += GRID_SIZE; }
                    attempts++;
                }
                return { x: 40, y: 40 };
            };

            const addPane = (e) => {
                e.preventDefault();
                if (!urlInput.trim()) return;
                let url = urlInput.startsWith('http') ? urlInput : 'https://' + urlInput;
                const { x, y } = findOpenSpot(DEFAULT_W, DEFAULT_H);
                setPanes([...panes, { id: generateId(), url, x, y, w: DEFAULT_W, h: DEFAULT_H, zIndex: panes.length + 1 }]);
                setUrlInput('');
            };

            const bringToFront = (id) => {
                const maxZ = Math.max(...panes.map(p => p.zIndex || 0), 0);
                setPanes(panes.map(p => p.id === id ? { ...p, zIndex: maxZ + 1 } : p));
            };

            const handleMouseDown = (e, id, type) => {
                e.preventDefault(); e.stopPropagation();
                const pane = panes.find(p => p.id === id);
                if (!pane) return;
                bringToFront(id);
                setDragState({ type, id, startX: e.clientX, startY: e.clientY, initX: pane.x, initY: pane.y, initW: pane.w, initH: pane.h });
            };

            useEffect(() => {
                const move = (e) => {
                    if (!dragState) return;
                    const dx = e.clientX - dragState.startX, dy = e.clientY - dragState.startY;
                    setPanes(prev => prev.map(p => {
                        if (p.id !== dragState.id) return p;
                        if (dragState.type === 'MOVE') return { ...p, x: Math.max(0, snap(dragState.initX + dx)), y: Math.max(0, snap(dragState.initY + dy)) };
                        return { ...p, w: Math.max(100, snap(dragState.initW + dx)), h: Math.max(100, snap(dragState.initH + dy)) };
                    }));
                };
                const up = () => setDragState(null);
                if (dragState) { window.addEventListener('mousemove', move); window.addEventListener('mouseup', up); }
                return () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
            }, [dragState]);

            return (
                <div className="h-screen w-screen overflow-hidden flex flex-col relative bg-slate-950">
                    <div className="absolute inset-0 pointer-events-none opacity-5" style={{ backgroundImage: `linear-gradient(to right, #fff 1px, transparent 1px), linear-gradient(to bottom, #fff 1px, transparent 1px)`, backgroundSize: '20px 20px' }} />

                    {/* Toolbar */}
                    <header className={`z-50 bg-slate-900 border-b border-slate-800 transition-all duration-300 ${isHeaderVisible ? 'h-16 opacity-100' : 'h-0 opacity-0 overflow-hidden'}`}>
                        <div className="p-3 flex items-center justify-between gap-4 h-full">
                            <div className="flex items-center gap-2">
                                <GridIcon size={20} className="text-indigo-500" />
                                <span className="font-bold text-sm hidden lg:block">GridBoard</span>
                            </div>
                            
                            <form onSubmit={addPane} className="flex-1 max-w-sm flex gap-2">
                                <input type="text" placeholder="Add URL..." className="flex-1 bg-slate-950 border border-slate-700 rounded px-3 py-1 text-sm outline-none focus:border-indigo-500 text-white" value={urlInput} onChange={e => setUrlInput(e.target.value)} />
                                <button type="submit" className="bg-indigo-600 px-3 py-1 rounded text-sm font-bold hover:bg-indigo-500 shrink-0"><Plus size={16}/></button>
                            </form>

                            {/* Storage Management */}
                            <div className="flex items-center gap-1 border-l border-slate-700 pl-4">
                                <select 
                                    className="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs text-slate-300 outline-none focus:border-indigo-500 max-w-[150px]"
                                    value={activeCollectionName}
                                    onChange={(e) => loadCollection(e.target.value)}
                                >
                                    <option value="">Stored Layouts...</option>
                                    {Object.keys(savedCollections).map(name => (
                                        <option key={name} value={name}>{name}</option>
                                    ))}
                                </select>
                                
                                <button onClick={saveCurrentLayout} className="p-2 text-slate-400 hover:text-indigo-400 transition-colors" title="Save Current Layout As..."><SaveIcon size={18}/></button>
                                
                                {activeCollectionName && (
                                    <button onClick={deleteCollection} className="p-2 text-slate-400 hover:text-red-400 transition-colors" title="Delete current layout"><Trash2 size={18}/></button>
                                )}
                            </div>

                            {/* Options & Import/Export */}
                            <div className="flex items-center gap-1 border-l border-slate-700 pl-4">
                                <button onClick={() => setCompactMode(!compactMode)} className={`p-2 rounded hover:bg-slate-800 transition-colors ${compactMode ? 'text-indigo-400' : 'text-slate-400'}`} title="Compact Mode">{compactMode ? <Monitor size={18}/> : <LayoutIcon size={18}/>}</button>
                                
                                <label className="p-2 text-slate-400 hover:text-white cursor-pointer transition-colors" title="Import JSON">
                                    <Upload size={18}/>
                                    <input type="file" accept=".json" onChange={importFromJson} className="hidden" />
                                </label>
                                
                                <button onClick={exportToJson} className="p-2 text-slate-400 hover:text-white transition-colors" title="Export current session to JSON"><Download size={18}/></button>
                                
                                <button onClick={() => setIsHeaderVisible(false)} className="p-2 text-slate-400 hover:text-white transition-colors" title="Hide Toolbar"><ChevronUp size={18}/></button>
                            </div>
                        </div>
                    </header>

                    {/* Floating Menu Toggle */}
                    {!isHeaderVisible && (
                        <button 
                            onClick={() => setIsHeaderVisible(true)}
                            className="absolute top-4 right-4 z-[60] p-2 bg-slate-800/80 hover:bg-slate-700 border border-slate-700 rounded-full text-slate-400 hover:text-white shadow-xl backdrop-blur-sm transition-all hover:scale-110 active:scale-95"
                            title="Show Toolbar"
                        >
                            <MenuIcon size={20} />
                        </button>
                    )}

                    <main ref={mainRef} className="flex-1 relative overflow-auto">
                        {panes.length === 0 && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-600 pointer-events-none select-none opacity-40">
                                <GridIcon size={64} className="mb-4" />
                                <p className="text-lg font-medium">Dashboard Empty</p>
                                <p className="text-sm">Enter a URL above to add a window</p>
                            </div>
                        )}
                        
                        {panes.map(p => (
                            <div key={p.id} className={`absolute flex flex-col bg-slate-900 rounded-lg shadow-2xl overflow-hidden border border-slate-700 transition-shadow ${dragState?.id === p.id ? 'ring-2 ring-indigo-500 shadow-indigo-500/20' : ''}`} style={{ width: p.w, height: p.h, transform: `translate(${p.x}px, ${p.y}px)`, zIndex: p.zIndex }} onMouseDown={() => bringToFront(p.id)}>
                                {/* Pane Header */}
                                <div className={`flex items-center justify-between px-2 cursor-move bg-slate-800 border-b border-slate-700 ${compactMode ? 'absolute top-0 left-0 right-0 z-10 h-8 opacity-0 hover:opacity-100 transition-opacity bg-slate-900/90' : 'h-8'}`} onMouseDown={e => handleMouseDown(e, p.id, 'MOVE')}>
                                    <span className="text-[10px] text-slate-400 truncate font-mono select-none">{p.url}</span>
                                    <button onClick={() => setPanes(panes.filter(x => x.id !== p.id))} className="text-slate-500 hover:text-red-400 p-1"><X size={14}/></button>
                                </div>
                                
                                {/* Iframe */}
                                <div className="flex-1 relative bg-white">
                                    {isInteracting && <div className="absolute inset-0 z-20 bg-transparent" />}
                                    <iframe src={p.url} className="w-full h-full border-0" />
                                </div>
                                
                                {/* Resize Handle */}
                                <div className="absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize z-30 group" onMouseDown={e => handleMouseDown(e, p.id, 'RESIZE')}>
                                    <Maximize2 size={10} className="text-slate-500 group-hover:text-indigo-400 absolute bottom-1 right-1 rotate-90" />
                                </div>
                            </div>
                        ))}
                    </main>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
